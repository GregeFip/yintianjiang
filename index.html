<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>引天降 · 阴阳飞宫精算版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f4f1ea; font-family: "PingFang SC", serif; }
        .palace-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; background: #8b0000; border: 4px solid #8b0000; }
        .palace-cell { background: white; height: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 2px; }
        .palace-name { font-size: 13px; font-weight: bold; color: #333; position: absolute; top: 4px; left: 6px; }
        .palace-num { font-size: 10px; color: #ddd; position: absolute; bottom: 2px; right: 4px; }
        .active-god { font-weight: bold; font-size: 12px; text-align: center; line-height: 1.1; width: 100%; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto bg-white shadow-xl rounded-xl overflow-hidden border-t-8 border-red-900">
        <div class="p-6">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-red-900 mb-1">太岁禄马贵人飞宫图</h1>
                <p class="text-xs text-gray-400 italic">支持阴阳贵人同步推演</p>
            </header>
            
            <div class="space-y-4 mb-6 bg-stone-50 p-4 rounded-lg border">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">流年年份</label>
                        <select id="yearSel" class="border p-2 rounded w-full bg-white text-lg font-serif"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">用事月份</label>
                        <select id="monthSel" class="border p-2 rounded w-full bg-white text-lg">
                            <option value="1">正月 (寅)</option><option value="2">二月 (卯)</option>
                            <option value="3">三月 (辰)</option><option value="4">四月 (巳)</option>
                            <option value="5">五月 (午)</option><option value="6">六月 (未)</option>
                            <option value="7">七月 (申)</option><option value="8">八月 (酉)</option>
                            <option value="9">九月 (戌)</option><option value="10">十月 (亥)</option>
                            <option value="11">十一月 (子)</option><option value="12">十二月 (丑)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">节气时段</label>
                    <div class="flex items-center gap-6 text-sm">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="dun" value="yang" checked class="accent-red-800"> 冬至后 (阳遁)</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="dun" value="yin" class="accent-red-800"> 夏至后 (阴遁)</label>
                    </div>
                </div>
                <button onclick="calculate()" class="w-full bg-red-900 text-white py-3 rounded-lg font-bold hover:bg-black transition shadow-md active:scale-95">
                    生成动态飞宫图
                </button>
            </div>

            <div id="resultGrid" class="hidden animate-in fade-in duration-500">
                <div class="text-center mb-3 text-sm font-bold text-stone-700">
                    <span id="monthGZDisplay" class="bg-red-100 px-2 py-0.5 rounded text-red-900"></span> 月入中宫 · <span id="dunDisplay"></span>
                </div>
                <div class="palace-grid">
                    <div class="palace-cell" id="p4"><span class="palace-name">巽宫</span><div class="active-god"></div><span class="palace-num">4</span></div>
                    <div class="palace-cell" id="p9"><span class="palace-name">离宫</span><div class="active-god"></div><span class="palace-num">9</span></div>
                    <div class="palace-cell" id="p2"><span class="palace-name">坤宫</span><div class="active-god"></div><span class="palace-num">2</span></div>
                    <div class="palace-cell" id="p3"><span class="palace-name">震宫</span><div class="active-god"></div><span class="palace-num">3</span></div>
                    <div class="palace-cell" id="p5" style="background:#fffcf0;"><span class="palace-name">中宫</span><div class="active-god"></div><span class="palace-num">5</span></div>
                    <div class="palace-cell" id="p7"><span class="palace-name">兑宫</span><div class="active-god"></div><span class="palace-num">7</span></div>
                    <div class="palace-cell" id="p8"><span class="palace-name">艮宫</span><div class="active-god"></div><span class="palace-num">8</span></div>
                    <div class="palace-cell" id="p1"><span class="palace-name">坎宫</span><div class="active-god"></div><span class="palace-num">1</span></div>
                    <div class="palace-cell" id="p6"><span class="palace-name">乾宫</span><div class="active-god"></div><span class="palace-num">6</span></div>
                </div>
                
                <div class="mt-6 space-y-2 border-t pt-4">
                    <div id="infoLu" class="flex justify-between p-2 bg-red-50 rounded text-xs"></div>
                    <div id="infoMa" class="flex justify-between p-2 bg-blue-50 rounded text-xs"></div>
                    <div id="infoGuiYang" class="flex justify-between p-2 bg-purple-50 rounded text-xs"></div>
                    <div id="infoGuiYin" class="flex justify-between p-2 bg-stone-100 rounded text-xs"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const stems = "甲乙丙丁戊己庚辛壬癸".split("");
        const branches = "子丑寅卯辰巳午未申酉戌亥".split("");
        const jiazi = [];
        for(let i=0; i<60; i++) jiazi.push(stems[i%10] + branches[i%12]);

        const yearSel = document.getElementById('yearSel');
        const now = new Date().getFullYear();
        for(let i = now + 15; i >= now - 85; i--) {
            let off = (i-4)%60; if(off<0) off+=60;
            yearSel.add(new Option(`${i}年 (${stems[off%10]}${branches[off%12]})`, i));
        }
        yearSel.value = now;

        function calculate() {
            const y = parseInt(yearSel.value);
            const m = parseInt(document.getElementById('monthSel').value);
            const isYang = document.querySelector('input[name="dun"]:checked').value === 'yang';
            
            let yOff = (y-4)%60; if(yOff<0) yOff+=60;
            const yS = stems[yOff%10], yB = branches[yOff%12];

            const getTrueGZ = (b) => {
                const start = {"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[yS];
                const diff = (branches.indexOf(b)-2+12)%12;
                return stems[(start+diff)%10] + b;
            };

            // 禄马贵人映射
            const luB = {"甲":"寅","乙":"卯","丙":"巳","丁":"午","戊":"巳","己":"午","庚":"申","辛":"酉","壬":"亥","癸":"子"}[yS];
            const maB = {"申":"寅","子":"寅","辰":"寅","寅":"申","午":"申","戌":"申","巳":"亥","酉":"亥","丑":"亥","亥":"巳","卯":"巳","未":"巳"}[yB];
            const yangGuiB = {"甲":"丑","乙":"子","丙":"亥","丁":"亥","戊":"丑","己":"子","庚":"丑","辛":"午","壬":"卯","癸":"卯"}[yS];
            const yinGuiB = {"甲":"未","乙":"申","丙":"酉","丁":"酉","戊":"未","己":"申","庚":"未","辛":"寅","壬":"巳","癸":"巳"}[yS];

            const luGZ = getTrueGZ(luB), maGZ = getTrueGZ(maB);
            const yangGuiGZ = getTrueGZ(yangGuiB), yinGuiGZ = getTrueGZ(yinGuiB);

            const mB = branches[(m+1)%12]; 
            const mS = stems[({"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[yS] + (m-1)) % 10];
            const monthGZ = mS + mB;

            const path = isYang ? [5,6,7,8,9,1,2,3,4] : [5,4,3,2,1,9,8,7,6];
            const getPalace = (targetGZ) => {
                let steps = (jiazi.indexOf(targetGZ) - jiazi.indexOf(monthGZ) + 60) % 60;
                return path[steps % 9];
            };

            document.querySelectorAll('.active-god').forEach(el => el.innerHTML = "");
            
            const renderGod = (gz, label, colorClass, infoId) => {
                const p = getPalace(gz);
                const pName = document.querySelector(`#p${p} .palace-name`).innerText;
                document.querySelector(`#p${p} .active-god`).innerHTML += `<div class="${colorClass} mb-0.5">${label}<span class="text-[9px] font-normal ml-0.5">${gz}</span></div>`;
                document.getElementById(infoId).innerHTML = `<b>${label}(${gz})</b> <span>飞：${pName}</span>`;
            };

            document.getElementById('resultGrid').classList.remove('hidden');
            document.getElementById('monthGZDisplay').innerText = monthGZ;
            document.getElementById('dunDisplay').innerText = isYang ? "阳遁顺飞" : "阴遁逆飞";

            renderGod(luGZ, "真禄", "text-red-700", "infoLu");
            renderGod(maGZ, "真马", "text-blue-700", "infoMa");
            renderGod(yangGuiGZ, "阳贵", "text-purple-700", "infoGuiYang");
            renderGod(yinGuiGZ, "阴贵", "text-stone-600", "infoGuiYin");
        }
    </script>
</body>
</html>
