<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="引天降">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>引天降 · 择日精算系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --brand-red: #b91c1c; --bg-dark: #0a0a0a; }
        body { background-color: var(--bg-dark); color: #d1d1d6; font-family: "PingFang SC", "STHeiti", sans-serif; -webkit-tap-highlight-color: transparent; }
        .yin-card { background: linear-gradient(145deg, #1c1c1e, #111112); border-top: 4px solid var(--brand-red); border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.8); }
        
        /* 核心修复：网格容器宽度自适应 */
        .palace-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1px; 
            background: #333; 
            border: 1px solid #333; 
            border-radius: 8px; 
            overflow: hidden; 
            width: 100%; /* 确保网格不超出父容器 */
            box-sizing: border-box;
        }
        
        .palace-cell { 
            background: #151517; 
            min-height: 80px; /* 移除 aspect-ratio，改用最小高度防止文字挤压 */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            padding: 8px 2px; 
        }
        
        .palace-name { font-size: 9px; color: #48484a; position: absolute; top: 4px; left: 4px; }
        .mountain-info { font-size: 7px; color: #2c2c2e; position: absolute; bottom: 2px; text-align: center; width: 100%; }
        
        /* 针对重叠文字的缩放优化 */
        .gods-container { font-size: 10px; line-height: 1.2; text-align: center; width: 100%; }
        .gods-item { margin-bottom: 2px; }

        select { -webkit-appearance: none; background-color: #1a1a1c !important; border: 1px solid #27272a !important; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 14px; }
        .btn-gold { background: linear-gradient(to right, #b91c1c, #7f1d1d); color: white; box-shadow: 0 4px 15px rgba(185, 28, 28, 0.4); }
        .overlap-item { border-left: 3px solid var(--brand-red); background: rgba(185, 28, 28, 0.05); padding: 10px; border-radius: 0 10px 10px 0; margin-bottom: 8px; }
    </style>
</head>
<body class="p-3 pb-10">
    <div class="w-full max-w-sm mx-auto"> <header class="text-center py-6">
            <div class="mb-3 inline-block w-14 h-14 rounded-full border border-red-900 overflow-hidden bg-white">
                <img src="icon.png" alt="Logo" onerror="this.style.display='none'" class="w-full h-full object-cover">
            </div>
            <h1 class="text-2xl font-black tracking-[0.3em] text-red-700">引天降</h1>
            <p class="text-[8px] text-zinc-600 mt-1 uppercase tracking-widest">Precision Metaphysics System</p>
        </header>

        <div class="yin-card p-5 mb-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-[9px] text-zinc-500 mb-1 font-bold uppercase">主要查询年</label>
                    <select id="pY" class="w-full rounded-lg p-3 text-sm font-serif outline-none"></select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[9px] text-zinc-500 mb-1 font-bold uppercase">月份</label>
                        <select id="m" class="w-full rounded-lg p-2 text-xs" onchange="toggleDun()">
                            <option value="0">常驻方位</option>
                            <option value="1">正月(寅)</option><option value="2">二月(卯)</option>
                            <option value="3">三月(辰)</option><option value="4">四月(巳)</option>
                            <option value="5">五月(午)</option><option value="6">六月(未)</option>
                            <option value="7">七月(申)</option><option value="8">八月(酉)</option>
                            <option value="9">九月(戌)</option><option value="10">十月(亥)</option>
                            <option value="11">十一月(子)</option><option value="12">十二月(丑)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[9px] text-zinc-500 mb-1 font-bold uppercase">对比年</label>
                        <select id="sY" class="w-full rounded-lg p-2 text-xs font-serif">
                            <option value="0">关闭</option>
                        </select>
                    </div>
                </div>

                <div id="dunBox" class="hidden">
                    <div class="flex gap-4 justify-center bg-zinc-900/50 py-2 rounded-lg border border-zinc-800 text-[9px]">
                        <label class="flex items-center gap-1"><input type="radio" name="d" value="y" checked class="accent-red-700"> 阳顺</label>
                        <label class="flex items-center gap-1"><input type="radio" name="d" value="i" class="accent-red-700"> 阴逆</label>
                    </div>
                </div>

                <button onclick="calculate()" class="w-full btn-gold py-3 rounded-xl font-bold text-xs tracking-widest uppercase">启动精算</button>
            </div>
        </div>

        <div id="res" class="hidden">
            <div id="resHeader" class="text-center mb-4 text-[10px] text-zinc-500 italic border-b border-zinc-900 pb-2"></div>
            <div id="displayArea" class="space-y-5"></div>
        </div>
    </div>

    <script>
        const S="甲乙丙丁戊己庚辛壬癸", B="子丑寅卯辰巳午未申酉戌亥", J=[];
        const P_NAME = {1:"坎宫", 2:"坤宫", 3:"震宫", 4:"巽宫", 5:"中宫", 6:"乾宫", 7:"兑宫", 8:"艮宫", 9:"离宫"};
        const P_MT = {1:"壬子癸", 2:"未坤申", 3:"甲卯乙", 4:"辰巽巳", 5:"中宫", 6:"戌乾亥", 7:"庚酉辛", 8:"丑艮寅", 9:"丙午丁"};
        const B_MAP = {"子":1,"丑":8,"寅":8,"卯":3,"辰":4,"巳":4,"午":9,"未":2,"申":2,"酉":7,"戌":6,"亥":6};
        for(let i=0;i<60;i++) J.push(S[i%10]+B[i%12]);

        const init = () => {
            const py=document.getElementById('pY'), sy=document.getElementById('sY'), now=new Date().getFullYear();
            for(let i=now+15; i>=now-85; i--){
                let o=(i-4)%60; if(o<0)o+=60;
                let opt=new Option(`${i}年 (${S[o%10]}${B[o%12]})`, i);
                py.add(opt.cloneNode(true)); sy.add(opt.cloneNode(true));
            }
            py.value=now; sy.value="0";
        };
        init();

        function toggleDun(){ document.getElementById('dunBox').classList.toggle('hidden', document.getElementById('m').value==="0"); }

        function getGods(y, wS) {
            let o=(y-4)%60; if(o<0)o+=60; let s=S[o%10], b=B[o%12];
            const getT=(tb)=>{
                const st={"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[wS];
                return S[(st+(B.indexOf(tb)-2+12)%12)%10]+tb;
            };
            return [
                {n:"真禄", tb:{"甲":"寅","乙":"卯","丙":"巳","丁":"午","戊":"巳","己":"午","庚":"申","辛":"酉","壬":"亥","癸":"子"}[s]},
                {n:"真马", tb:{"申":"寅","子":"寅","辰":"寅","寅":"申","午":"申","戌":"申","巳":"亥","酉":"亥","丑":"亥","亥":"巳","卯":"巳","未":"巳"}[b]},
                {n:"阳贵", tb:{"甲":"丑","乙":"子","丙":"亥","丁":"亥","戊":"丑","己":"子","庚":"丑","辛":"午","壬":"卯","癸":"卯"}[s]},
                {n:"阴贵", tb:{"甲":"未","乙":"申","丙":"酉","丁":"酉","戊":"未","己":"申","庚":"未","辛":"寅","壬":"巳","癸":"巳"}[s]}
            ].map(x=>({...x, gz:getT(x.tb)}));
        }

        function buildP(gods_data=[]) {
            let h = `<div class="palace-grid">`;
            [4,9,2,3,5,7,8,1,6].forEach(i=>{
                let cG = gods_data.filter(g=>g.p===i).map(g=>`<div class="gods-item ${g.c}">${g.n}<br><span class="text-[7px]">${g.gz}</span></div>`).join('');
                h += `<div class="palace-cell"><span class="palace-name">${P_NAME[i]}</span><div class="gods-container">${cG}</div><span class="mountain-info">${P_MT[i]}</span></div>`;
            });
            return h + `</div>`;
        }

        function calculate() {
            const py=parseInt(document.getElementById('pY').value), sy=parseInt(document.getElementById('sY').value),
                  m=parseInt(document.getElementById('m').value), isY=document.querySelector('input[name="d"]:checked').value==='y';
            const resArea=document.getElementById('displayArea'), resH=document.getElementById('resHeader');
            document.getElementById('res').classList.remove('hidden');
            resArea.innerHTML="";

            if(sy > 0) { // 扫描
                resH.innerText=`叠吉比对：${py}年本命 与 ${sy}年太岁`;
                let found=false; let tO=(sy-4)%60; if(tO<0)tO+=60; let ts=S[tO%10];
                const bG=getGods(py, ts), tG=getGods(sy, ts);

                for(let mo=1; mo<=12; mo++) {
                    ["yang", "yin"].forEach(dun=>{
                        const isDunY=dun==="yang"; if((isDunY&&mo>5)||(!isDunY&&mo<=5)) return;
                        const mB=B[(mo+1)%12], mS=S[({"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[ts]+(mo-1))%10], mGZ=mS+mB;
                        const path=isDunY?[5,6,7,8,9,1,2,3,4]:[5,4,3,2,1,9,8,7,6];
                        const getP=(gz)=>path[((J.indexOf(gz)-J.indexOf(mGZ)+60)%60)%9];

                        let matches=[];
                        bG.forEach(bg=>tG.forEach(tg=>{ if(getP(bg.gz)===getP(tg.gz)) matches.push({p:getP(bg.gz), bN:bg.n, bG:bg.gz, tN:tg.n, tG:tg.gz}); }));

                        if(matches.length>0) {
                            found=true; let card=`<div class="bg-zinc-900/30 p-3 rounded-2xl border border-zinc-800">
                                <div class="flex justify-between items-center mb-3 text-[10px] font-bold">
                                    <span class="text-red-600">${mo}月(${mGZ}) · ${isDunY?'阳顺':'阴逆'}</span>
                                    <span class="bg-red-900/30 text-red-500 px-2 py-0.5 rounded text-[8px]">OVERLAP</span>
                                </div>`;
                            let pD=[]; 
                            bG.forEach(g=>pD.push({p:getP(g.gz), n:"本"+g.n, gz:g.gz, c:"text-red-500 font-bold"}));
                            tG.forEach(g=>pD.push({p:getP(g.gz), n:"岁"+g.n, gz:g.gz, c:"text-zinc-500"}));
                            card += buildP(pD);
                            matches.forEach(mx=> card+=`<div class="overlap-item mt-2 text-[9px]"><div class="font-bold">本命${mx.bN} 叠 太岁${mx.tN}</div><div class="text-zinc-500 mt-1">方位：${P_NAME[mx.p]} (${P_MT[mx.p]})</div></div>`);
                            resArea.innerHTML += card + `</div>`;
                        }
                    });
                }
                if(!found) resArea.innerHTML=`<p class="text-center py-10 text-zinc-600 italic">年度暂无重叠吉位</p>`;
            } else if(m === 0) { // 静态
                resH.innerText = `${py}年 静态常驻方位 (二十四山模式)`;
                let pD=[]; let o=(py-4)%60; if(o<0)o+=60; const gods=getGods(py, S[o%10]);
                gods.forEach(g=>pD.push({p:B_MAP[g.tb], n:g.n, gz:g.gz, c: "text-red-600 font-bold"}));
                resArea.innerHTML=buildP(pD);
                gods.forEach(g=> resArea.innerHTML+=`<div class="overlap-item flex justify-between mt-2 text-[10px]"><span><b>${g.n}</b> (${g.gz})</span> <span class="text-zinc-500 italic">${g.tb}山</span></div>`);
            } else { // 动态
                let o=(py-4)%60; if(o<0)o+=60; let ts=S[o%10];
                const mB=B[(m+1)%12], mS=S[({"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[ts]+(m-1))%10], mGZ=mS+mB;
                const path=isY?[5,6,7,8,9,1,2,3,4]:[5,4,3,2,1,9,8,7,6];
                resH.innerText=`${mGZ}月 飞宫推演算图 (${isY?'阳顺':'阴逆'})`;
                const gods=getGods(py, ts); let pD=[];
                gods.forEach(g=>{ let p=path[((J.indexOf(g.gz)-J.indexOf(mGZ)+60)%60)%9]; pD.push({p, n:g.n, gz:g.gz, c:"text-red-600 font-bold"}); });
                resArea.innerHTML=buildP(pD);
                gods.forEach(g=>{ let p=path[((J.indexOf(g.gz)-J.indexOf(mGZ)+60)%60)%9]; resArea.innerHTML+=`<div class="overlap-item flex justify-between mt-2 text-[10px]"><span><b>${g.n}</b> (${g.gz})</span> <span class="text-zinc-500 italic">飞临${P_NAME[p]}</span></div>`; });
            }
            window.scrollTo({top: document.getElementById('res').offsetTop - 30, behavior: 'smooth'});
        }
    </script>
</body>
</html>