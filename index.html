<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>引天降 · 择日精算全功版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #121212; color: #d4d4d8; font-family: "PingFang SC", "STHeiti", sans-serif; -webkit-font-smoothing: antialiased; }
        .yin-card { background: linear-gradient(145deg, #1e1e1e, #181818); border-top: 4px solid #991b1b; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .palace-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: #3f3f46; border: 2px solid #3f3f46; border-radius: 12px; overflow: hidden; }
        .palace-cell { background: #18181b; aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 4px; }
        .palace-name { font-size: 11px; color: #71717a; position: absolute; top: 4px; left: 6px; }
        .active-god { font-size: 10px; text-align: center; line-height: 1.1; }
        .btn-action { background: linear-gradient(to right, #991b1b, #7f1d1d); color: white; transition: all 0.2s; box-shadow: 0 4px 15px rgba(153, 27, 27, 0.4); }
        .btn-action:active { transform: scale(0.96); opacity: 0.9; }
        select { -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto">
        <header class="text-center py-8">
            <h1 class="text-3xl font-extrabold tracking-[0.3em] text-red-700">引天降</h1>
            <p class="text-[10px] text-zinc-500 mt-2 uppercase tracking-widest">真禄马贵人 · 动静双元精算</p>
        </header>

        <div class="yin-card p-6 mb-6">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-500 mb-2">流年流月</label>
                        <select id="y" class="w-full bg-zinc-900 border-none rounded-xl p-4 text-sm font-serif focus:ring-1 focus:ring-red-700"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-500 mb-2">&nbsp;</label>
                        <select id="m" class="w-full bg-zinc-900 border-none rounded-xl p-4 text-sm" onchange="toggleDun()">
                            <option value="0">常驻方位 (不选月)</option>
                            <option value="1">正月(寅)</option><option value="2">二月(卯)</option>
                            <option value="3">三月(辰)</option><option value="4">四月(巳)</option>
                            <option value="5">五月(午)</option><option value="6">六月(未)</option>
                            <option value="7">七月(申)</option><option value="8">八月(酉)</option>
                            <option value="9">九月(戌)</option><option value="10">十月(亥)</option>
                            <option value="11">十一月(子)</option><option value="12">十二月(丑)</option>
                        </select>
                    </div>
                </div>

                <div id="dunBox" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                    <div class="flex gap-6 justify-center bg-zinc-900/40 py-3 rounded-xl border border-zinc-800">
                        <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="radio" name="d" value="y" checked class="accent-red-700"> 冬至后(阳)</label>
                        <label class="flex items-center gap-2 text-xs cursor-pointer"><input type="radio" name="d" value="i" class="accent-red-700"> 夏至后(阴)</label>
                    </div>
                </div>

                <button onclick="calc()" class="w-full btn-action py-4 rounded-2xl font-bold text-base tracking-widest mt-2">启动推演</button>
            </div>
        </div>

        <div id="res" class="hidden animate-in fade-in zoom-in duration-500 pb-10">
            <div id="modeHeader" class="text-center mb-5 p-2 rounded-lg bg-zinc-900 border border-zinc-800 text-xs"></div>
            
            <div class="palace-grid mb-6 shadow-2xl">
                <div class="palace-cell" id="p4"><span class="palace-name">巽宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p9"><span class="palace-name">离宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p2"><span class="palace-name">坤宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p3"><span class="palace-name">震宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p5" style="background: #251818;"><span class="palace-name">中宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p7"><span class="palace-name">兑宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p8"><span class="palace-name">艮宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p1"><span class="palace-name">坎宫</span><div class="active-god"></div></div>
                <div class="palace-cell" id="p6"><span class="palace-name">乾宫</span><div class="active-god"></div></div>
            </div>
            
            <div class="space-y-3">
                <div id="iL" class="bg-red-950/20 p-4 rounded-xl border-l-4 border-red-700 flex justify-between items-center text-xs"></div>
                <div id="iM" class="bg-blue-950/20 p-4 rounded-xl border-l-4 border-blue-600 flex justify-between items-center text-xs"></div>
                <div id="iY" class="bg-purple-950/20 p-4 rounded-xl border-l-4 border-purple-600 flex justify-between items-center text-xs"></div>
                <div id="iN" class="bg-zinc-800/40 p-4 rounded-xl border-l-4 border-zinc-500 flex justify-between items-center text-xs"></div>
            </div>
        </div>
    </div>

    <script>
        const S="甲乙丙丁戊己庚辛壬癸", B="子丑寅卯辰巳午未申酉戌亥", J=[];
        for(let i=0;i<60;i++) J.push(S[i%10]+B[i%12]);

        const yS = document.getElementById('y'), now = new Date().getFullYear();
        for(let i=now+15;i>=now-85;i--){
            let o=(i-4)%60; if(o<0)o+=60;
            yS.add(new Option(`${i}年(${S[o%10]}${B[o%12]})`, i));
        }
        yS.value = now;

        function toggleDun(){
            const m = document.getElementById('m').value;
            document.getElementById('dunBox').classList.toggle('hidden', m == "0");
        }

        function calc(){
            const y=parseInt(yS.value), m=parseInt(document.getElementById('m').value), 
                  isY=document.querySelector('input[name="d"]:checked').value==='y';
            let o=(y-4)%60; if(o<0)o+=60; let s=S[o%10], b=B[o%12];

            // 真神干支计算 (五虎遁)
            const getG=(tb)=>{
                const st={"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[s];
                return S[(st+(B.indexOf(tb)-2+12)%12)%10]+tb;
            };

            const lB={"甲":"寅","乙":"卯","丙":"巳","丁":"午","戊":"巳","己":"午","庚":"申","辛":"酉","壬":"亥","癸":"子"}[s];
            const mB={"申":"寅","子":"寅","辰":"寅","寅":"申","午":"申","戌":"申","巳":"亥","酉":"亥","丑":"亥","亥":"巳","卯":"巳","未":"巳"}[b];
            const ayB={"甲":"丑","乙":"子","丙":"亥","丁":"亥","戊":"丑","己":"子","庚":"丑","辛":"午","壬":"卯","癸":"卯"}[s];
            const aiB={"甲":"未","乙":"申","丙":"酉","丁":"酉","戊":"未","己":"申","庚":"未","辛":"寅","壬":"巳","癸":"巳"}[s];

            const lG=getG(lB), mG=getG(mB), yG=getG(ayB), nG=getG(aiB);

            // 清空旧结果
            document.querySelectorAll('.active-god').forEach(e=>e.innerHTML="");
            document.getElementById('res').classList.remove('hidden');

            if(m == 0) { // 静态模式：到山方位
                const bToP = {"子":1,"丑":8,"寅":8,"卯":3,"辰":4,"巳":4,"午":9,"未":2,"申":2,"酉":7,"戌":6,"亥":6};
                document.getElementById('modeHeader').innerHTML = `<span class="text-red-600 font-bold">${s}${b}年</span> 静态方位推演 (不计流月)`;
                
                const renSt=(gz,lb,cl,id,tb)=>{
                    const p = bToP[tb];
                    document.querySelector(`#p${p} .active-god`).innerHTML+=`<div class="${cl} font-bold">${lb}<br><span class='text-[8px] font-normal'>${gz}</span></div>`;
                    document.getElementById(id).innerHTML=`<span><b>${lb}</b> ${gz}</span> <span class="text-zinc-500 italic">常驻：${tb}山</span>`;
                };
                renSt(lG,"真禄","text-red-500","iL",lB); renSt(mG,"真马","text-blue-400","iM",mB);
                renSt(yG,"阳贵","text-purple-400","iY",ayB); renSt(nG,"阴贵","text-zinc-400","iN",aiB);
            } else { // 动态模式：飞宫精算
                const mbB=B[(m+1)%12], msS=S[({"甲":2,"己":2,"乙":4,"庚":4,"丙":6,"辛":6,"丁":8,"壬":8,"戊":0,"癸":0}[s]+(m-1))%10];
                const mGZ=msS+mbB;
                const path=isY?[5,6,7,8,9,1,2,3,4]:[5,4,3,2,1,9,8,7,6];
                const getP=(gz)=>{ let st=(J.indexOf(gz)-J.indexOf(mGZ)+60)%60; return path[st%9]; };

                document.getElementById('modeHeader').innerHTML = `<span class="text-red-600 font-bold">${mGZ}月</span> 入中飞宫推演 (${isY?'阳顺':'阴逆'})`;
                const renFy=(gz,lb,cl,id)=>{
                    const p=getP(gz), pN=document.querySelector(`#p${p} .palace-name`).innerText;
                    document.querySelector(`#p${p} .active-god`).innerHTML+=`<div class="${cl} font-bold">${lb}<br><span class='text-[8px] font-normal'>${gz}</span></div>`;
                    document.getElementById(id).innerHTML=`<span><b>${lb}</b> ${gz}</span> <span class="text-zinc-500 italic">飞临：${pN}</span>`;
                };
                renFy(lG,"真禄","text-red-500","iL"); renFy(mG,"真马","text-blue-400","iM");
                renFy(yG,"阳贵","text-purple-400","iY"); renFy(nG,"阴贵","text-zinc-400","iN");
            }
            window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        }
    </script>
</body>
</html>